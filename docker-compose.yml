version: '3.8'

services:
  # Python FastAPI Backend
  python-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: docubot-python-api
    ports:
      - "8000:8000"
    environment:
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Langfuse (optional)
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      # Mistral (optional)
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      # CORS - Update with your production domain
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - docubot-network

  # Next.js Frontend
  nextjs-frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: docubot-nextjs
    ports:
      - "3000:3000"
    environment:
      # Supabase (public keys - safe for client)
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      # Supabase (server-side only)
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_KEY}
      # Python API URL - use service name for internal communication
      - PYTHON_API_URL=http://python-api:8000
      - NEXT_PUBLIC_PYTHON_API_URL=${NEXT_PUBLIC_PYTHON_API_URL:-http://python-api:8000}
      # Langfuse (server-side)
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      # N8N Webhook (optional)
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}
      - NEXT_PUBLIC_N8N_WEBHOOK_URL=${NEXT_PUBLIC_N8N_WEBHOOK_URL}
      # Site URL - Update with your production domain
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
    depends_on:
      python-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - docubot-network

networks:
  docubot-network:
    driver: bridge

