#!/usr/bin/env node

/**
 * Fix validator.ts paths generated by Next.js
 * 
 * Next.js has a bug where it generates validator.ts with paths pointing to
 * ../../src/app/ instead of ../../app/ when both app/ and src/ directories exist.
 * 
 * This script fixes those paths. Run it after Next.js generates the validator.ts
 * file but before type checking (which is difficult to automate, so this is
 * a manual workaround until Next.js fixes the bug).
 * 
 * Usage: node scripts/fix-validator.js
 */

import { readFileSync, writeFileSync, existsSync, watchFile } from 'fs';
import { join } from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const validatorPath = join(__dirname, '..', '.next', 'types', 'validator.ts');

function fixValidator() {
  if (!existsSync(validatorPath)) {
    console.log('⚠ validator.ts not found yet');
    return false;
  }
  
  try {
    let content = readFileSync(validatorPath, 'utf-8');
    const originalContent = content;
    
    // Replace all instances of ../../src/app/ with ../../app/
    content = content.replace(/\.\.\/\.\.\/src\/app\//g, '../../app/');
    
    // Also fix in comments
    content = content.replace(/\/\/ Validate \.\.\/\.\.\/src\/app\//g, '// Validate ../../app/');
    
    if (content !== originalContent) {
      writeFileSync(validatorPath, content, 'utf-8');
      console.log('✓ Fixed validator.ts paths (../../src/app/ → ../../app/)');
      return true;
    } else {
      console.log('✓ validator.ts paths are already correct');
      return true;
    }
  } catch (error) {
    console.error('✗ Error fixing validator.ts:', error.message);
    return false;
  }
}

// If run directly (not imported)
if (import.meta.url === `file://${process.argv[1]}`) {
  const fixed = fixValidator();
  process.exit(fixed ? 0 : 1);
}

export { fixValidator };













